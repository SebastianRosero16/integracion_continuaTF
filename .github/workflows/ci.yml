name: CI/CD Pipeline - Colegio Mentes Creativas

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  install:
    name: "ğŸ“¦ Install Dependencies"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      - run: npm ci
      - uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

  lint:
    name: "ğŸ” Lint & Format Check"
    runs-on: ubuntu-latest
    needs: install
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      - uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
      - run: npm run lint
      - run: npm run type-check

  test:
    name: "ğŸ§ª Unit Tests (Jest)"
    runs-on: ubuntu-latest
    needs: install
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      - uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
      - run: npm test -- --coverage --watchAll=false
      - uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
      - run: |
          echo "Coverage report generated"
          cat coverage/coverage-summary.json || echo "No coverage summary"

  build:
    name: "ğŸ—ï¸ Build Project"
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      - uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
      - run: npm ci   # extra safety si la cachÃ© no aparece
      - run: npm run build
      - uses: actions/upload-artifact@v4   # <-- actualizado
        with:
          name: dist-files
          path: dist/
          retention-days: 7

  code-quality:
    name: "ğŸ“Š Code Quality Analysis"
    runs-on: ubuntu-latest
    needs: install
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      - uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
      - run: |
          echo "Running code quality checks..."
          npm run lint || echo "Linting completed with warnings"

  security:
    name: "ğŸ”’ Security Audit"
    runs-on: ubuntu-latest
    needs: install
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: npm audit --audit-level=moderate || echo "Security audit completed"

  summary:
    name: "ğŸ“‹ Pipeline Summary"
    runs-on: ubuntu-latest
    needs: [lint, test, build, code-quality, security]
    if: always()
    steps:
      - name: Check pipeline status
        run: |
          echo "================================"
          echo "CI/CD Pipeline Summary"
          echo "================================"
          echo "âœ… Lint & Format: ${{ needs.lint.result }}"
          echo "âœ… Unit Tests: ${{ needs.test.result }}"
          echo "âœ… Build: ${{ needs.build.result }}"
          echo "âœ… Code Quality: ${{ needs['code-quality'].result }}"
          echo "âœ… Security: ${{ needs.security.result }}"
          echo "================================"
      - name: Generate badge
        run: |
          if [ "${{ needs.test.result }}" == "success" ] && [ "${{ needs.build.result }}" == "success" ]; then
            echo "ğŸ‰ All checks passed!"
          else
            echo "âŒ Some checks failed"
            exit 1
          fi

  deploy-notification:
    name: "ğŸš€ Deploy Notification"
    runs-on: ubuntu-latest
    needs: [build]
    if: success() && github.ref == 'refs/heads/main'
    steps:
      - run: |
          echo "ğŸ‰ Build successful!"
          echo "ğŸ“¦ Artifacts ready for deployment to Vercel"
          echo "ğŸ”— Deployment can be triggered manually or automatically"
